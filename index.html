<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Pelacakan Penjualan</title>
  <style>
    body {font-family: Arial, sans-serif; background:#f0f2f5; padding:20px; color:#333;}
    .container {background:#fff; padding:20px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1); max-width:650px; margin:auto;}
    h1,h2{text-align:center;color:#0056b3;}
    .form-row{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;}
    .input-group{flex:1;min-width:140px;}
    label{display:block;margin-bottom:5px;font-weight:bold;}
    input{width:100%;padding:8px;border:1px solid #ddd;border-radius:5px;font-size:16px;box-sizing:border-box;}
    button{width:100%;padding:10px;margin-top:8px;border:none;border-radius:5px;font-size:15px;cursor:pointer;color:#fff;}
    button:hover{opacity:0.9;}
    button.edit-button{background:#ffc107;color:#000;}
    button.simpan-button{background:#28a745;}
    button.hapus-button{background:#dc3545;}
    button.main{background:#007bff;}
    .data-item{background:#e9f5ff;border-left:5px solid #007bff;padding:12px;border-radius:8px;margin-bottom:10px;}
    .lunas{border-color:#28a745;background:#eafff0;}
    .belum-lunas{border-color:#dc3545;background:#fff0f0;}
    .uang{font-weight:bold;color:#007bff;}
    .laporan-keuangan{margin-top:25px;padding:15px;border:2px solid #8a2be2;border-radius:8px;background:#f8f4ff;}
    .data-item p{margin:4px 0;}
    .edit-fields{display:none;}
  </style>
</head>
<body>

<div class="container">
  <h1>Pelacakan Penjualan Karung Gadu 2025</h1>
  <div class="form-row">
    <div class="input-group">
      <label for="nama_pelanggan">Nama</label>
      <input type="text" id="nama_pelanggan" placeholder="cth: Hepi Susanto">
    </div>
    <div class="input-group">
      <label for="kodi_terjual">Kodi</label>
      <input type="text" id="kodi_terjual" value="0">
    </div>
    <div class="input-group">
      <label for="sudah_bayar">Bayar</label>
      <input type="text" id="sudah_bayar" value="0">
    </div>
    <div class="input-group">
      <label for="harga_modal">Modal/Kodi</label>
      <input type="text" id="harga_modal" value="0">
    </div>
  </div>
  <button class="main" onclick="tambahData()">Tambah</button>
  <button class="main" onclick="tampilkanLaporan()">Hitung Laporan</button>

  <div id="hasil-penjualan">
    <h2>Laporan Penjualan</h2>
    <div id="daftar_penjualan"></div>
  </div>

  <div id="laporan-keuangan-container" style="display:none;">
    <div class="laporan-keuangan">
      <h2>Laporan Keuangan</h2>
      <p><strong>Omzet:</strong> <span id="omzet">Rp 0</span></p>
      <p><strong>Total Modal:</strong> <span id="total_modal">Rp 0</span></p>
      <p><strong>Laba Kotor (Gross Profit):</strong> <span id="laba_kotor">Rp 0</span></p>
      <p><strong>Laba Bersih (Net Income):</strong> <span id="laba_bersih">Rp 0</span></p>
    </div>
  </div>
</div>

<script>
  const hargaPerKodi = 45000;
  let dataPelanggan = {};

  // GANTI INI DENGAN JSONBIN PUNYAMU
  const API_KEY = "$2a$10$i2DZWNMVKQF6aE6ywePaVukOPhSZ38yYdGCSBwNB.MlpyDyHx7vf6";
  const BIN_ID = "68b93dd043b1c97be9364293";

  // Format angka ribuan
  function formatNumber(num) {
    if (num === undefined || num === null || isNaN(num)) return "0";
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }
  function parseNumber(str) {
    return parseInt((str || "0").replace(/\./g, "")) || 0;
  }

  // Input angka auto format
  document.querySelectorAll("input[type=text]").forEach(input=>{
    input.addEventListener("input", e=>{
      if(input.id !== "nama_pelanggan"){
        let angka = parseNumber(input.value);
        input.value = formatNumber(angka);
      }
    });
  });

  async function simpanData() {
    try {
      await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
        body: JSON.stringify(dataPelanggan)
      });
    } catch (err) {
      console.error("Gagal simpan:", err);
    }
  }

  async function muatData() {
    try {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
        headers: { "X-Master-Key": API_KEY }
      });
      const result = await res.json();
      dataPelanggan = result.record || {};

      // Tambahkan tanggal_update untuk data lama
      Object.keys(dataPelanggan).forEach(nama=>{
        if(!dataPelanggan[nama].tanggal_update){
          dataPelanggan[nama].tanggal_update = "-";
        }
      });

      tampilkanLaporan();
    } catch (err) {
      console.error("Gagal muat:", err);
    }
  }

  function tambahData() {
    const nama = document.getElementById("nama_pelanggan").value.trim();
    const kodi = parseNumber(document.getElementById("kodi_terjual").value);
    const bayar = parseNumber(document.getElementById("sudah_bayar").value);
    const modal = parseNumber(document.getElementById("harga_modal").value);

    if (!nama || kodi <= 0) { alert("Isi nama & kodi valid!"); return; }

    dataPelanggan[nama] = {
      kodi_terjual: kodi,
      pembayaran_awal: bayar,
      harga_modal: modal,
      tanggal_update: new Date().toLocaleString("id-ID")
    };

    simpanData();
    tampilkanLaporan();

    document.getElementById("nama_pelanggan").value = "";
    document.getElementById("kodi_terjual").value = "0";
    document.getElementById("sudah_bayar").value = "0";
    document.getElementById("harga_modal").value = "0";
  }

  function tampilkanLaporan() {
    const container = document.getElementById("daftar_penjualan");
    container.innerHTML = "";

    let totalOmzet=0, totalUtang=0, totalModal=0;

    const dataArray = Object.keys(dataPelanggan).map(key=>({
      nama:key, data:dataPelanggan[key]
    }));

    // Urutkan: belum lunas di atas
    dataArray.sort((a,b)=>{
      const sisaA = (a.data.kodi_terjual*hargaPerKodi)-a.data.pembayaran_awal;
      const sisaB = (b.data.kodi_terjual*hargaPerKodi)-b.data.pembayaran_awal;
      if(sisaA>0 && sisaB<=0) return -1;
      if(sisaA<=0 && sisaB>0) return 1;
      return 0;
    });

    dataArray.forEach(item=>{
      const {nama,data} = item;
      const totalTagihan = data.kodi_terjual*hargaPerKodi;
      const sisaUtang = totalTagihan-data.pembayaran_awal;
      const statusClass = sisaUtang>0?"belum-lunas":"lunas";
      const statusText = sisaUtang>0?"Belum Lunas":"Lunas";

      totalOmzet += totalTagihan;
      totalUtang += sisaUtang;
      totalModal += data.kodi_terjual*data.harga_modal;

      container.innerHTML += `
        <div class="data-item ${statusClass}" data-nama="${nama}">
          <p><strong>Nama:</strong> ${nama}</p>
          <p><strong>Kodi:</strong> ${formatNumber(data.kodi_terjual)}</p>
          <p><strong>Total Bayar:</strong> Rp ${formatNumber(totalTagihan)}</p>
          <p><strong>Sudah Bayar:</strong> Rp ${formatNumber(data.pembayaran_awal)}</p>
          <p><strong>Sisa Utang:</strong> Rp ${formatNumber(sisaUtang)}</p>
          <p><strong>Status:</strong> ${statusText}</p>
          <p><strong>Tanggal Update:</strong> ${data.tanggal_update?data.tanggal_update:"-"}</p>
          <button class="edit-button" onclick="toggleEdit('${nama}')">Edit</button>
          <button class="simpan-button" style="display:none;" onclick="simpanEdit('${nama}')">Simpan</button>
          <button class="hapus-button" onclick="hapusData('${nama}')">Hapus</button>
          <div class="edit-fields">
            <input type="text" class="edit-kodi" value="${formatNumber(data.kodi_terjual)}">
            <input type="text" class="edit-bayar" value="${formatNumber(data.pembayaran_awal)}">
            <input type="text" class="edit-modal" value="${formatNumber(data.harga_modal)}">
          </div>
        </div>
      `;
    });

    const labaKotor = totalOmzet-totalModal;
    const labaBersih = labaKotor-totalUtang;

    document.getElementById("omzet").innerText="Rp "+formatNumber(totalOmzet);
    document.getElementById("total_modal").innerText="Rp "+formatNumber(totalModal);
    document.getElementById("laba_kotor").innerText="Rp "+formatNumber(labaKotor);
    document.getElementById("laba_bersih").innerText="Rp "+formatNumber(labaBersih);
    document.getElementById("laporan-keuangan-container").style.display="block";
  }

  function toggleEdit(nama){
    const item=document.querySelector(`.data-item[data-nama="${nama}"]`);
    const editFields=item.querySelector(".edit-fields");
    const simpanBtn=item.querySelector(".simpan-button");
    const editBtn=item.querySelector(".edit-button");
    const hapusBtn=item.querySelector(".hapus-button");

    editFields.style.display="block";
    simpanBtn.style.display="inline-block";
    editBtn.style.display="none";
    hapusBtn.style.display="none";
  }

  function simpanEdit(nama){
    const item=document.querySelector(`.data-item[data-nama="${nama}"]`);
    const kodiBaru=parseNumber(item.querySelector(".edit-kodi").value);
    const bayarBaru=parseNumber(item.querySelector(".edit-bayar").value);
    const modalBaru=parseNumber(item.querySelector(".edit-modal").value);

    if(kodiBaru<=0){alert("Kodi harus >0");return;}

    dataPelanggan[nama].kodi_terjual=kodiBaru;
    dataPelanggan[nama].pembayaran_awal=bayarBaru;
    dataPelanggan[nama].harga_modal=modalBaru;
    dataPelanggan[nama].tanggal_update=new Date().toLocaleString("id-ID");

    simpanData();
    tampilkanLaporan();
  }

  function hapusData(nama){
    if(confirm("Hapus data "+nama+"?")){
      delete dataPelanggan[nama];
      simpanData();
      tampilkanLaporan();
    }
  }

  window.onload=muatData;
</script>
</body>
  </html>
